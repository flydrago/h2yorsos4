<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.h2y.os.dao.read.ICouponsDaoR">

	<resultMap type="com.h2y.os.entity.Coupons" id="couponsDaoMap">
		<result property="id" column="id" javaType="long" jdbcType="BIGINT" />
		<result property="unitId" column="unit_id" javaType="long" jdbcType="BIGINT" />
		<result property="unitType" column="unit_type" javaType="int" jdbcType="INTEGER" />
		<result property="zoneCode" column="zone_code" javaType="string" jdbcType="VARCHAR" />
		<result property="couponsCode" column="coupons_code" javaType="string" jdbcType="VARCHAR" />
		<result property="couponsName" column="coupons_name" javaType="string" jdbcType="VARCHAR" />
		<result property="couponsBalance" column="coupons_balance" javaType="double" jdbcType="DOUBLE" />
		<result property="createDate" column="create_date" javaType="date" jdbcType="TIMESTAMP" />
		<result property="startDate" column="start_date" javaType="date" jdbcType="TIMESTAMP" />
		<result property="endDate" column="end_date" javaType="date" jdbcType="TIMESTAMP" />
		<result property="status" column="status" javaType="int" jdbcType="INTEGER" />
		<result property="isActivity" column="is_activity" javaType="int" jdbcType="INTEGER" />
		<result property="isMulti" column="is_multi" javaType="int" jdbcType="INTEGER" />
		<result property="isLimitAmount" column="is_limit_amount" javaType="int" jdbcType="INTEGER" />
		<result property="limitAmount" column="limit_amount" javaType="double" jdbcType="DOUBLE" />
		<result property="isLimitType" column="is_limit_type" javaType="int" jdbcType="INTEGER" />
		<result property="limitType" column="limit_type" javaType="string" jdbcType="VARCHAR" />
		<result property="isLimitMark" column="is_limit_mark" javaType="int" jdbcType="INTEGER" />
		<result property="limitMark" column="limit_mark" javaType="string" jdbcType="VARCHAR" />
		<result property="isLimitGoods" column="is_limit_goods" javaType="int" jdbcType="INTEGER" />
		<result property="limitGoods" column="limit_goods" javaType="long" jdbcType="BIGINT" />
		<result property="isLimitPlatform" column="is_limit_platform" javaType="int" jdbcType="INTEGER" />
		<result property="limitPlatform" column="limit_platform" javaType="string" jdbcType="VARCHAR" />
		<result property="memo" column="memo" javaType="string" jdbcType="VARCHAR" />
		<result property="str1" column="str_1" javaType="string" jdbcType="VARCHAR" />
		<result property="str2" column="str_2" javaType="string" jdbcType="VARCHAR" />
		<result property="isLimitCount" column="is_limit_count" javaType="int" jdbcType="INTEGER" />
		<result property="limitCount" column="limit_count" javaType="long" jdbcType="BIGINT" />
		<result property="claimedCount" column="claimed_count" javaType="long" jdbcType="BIGINT" />
	</resultMap>
	
	<select id="get" parameterType="long"
		resultMap="couponsDaoMap">
		select * from tb_coupons where id = #{id}
	</select>
	
	
	<!-- 获取我的优惠券列表 -->
	<select id="getMyCouponsList" parameterType="hashmap" resultType="hashmap">
		select f.*,n.short_name from (	
			select t.coupons_code,t.coupons_name,
			convert(t.coupons_balance,char(6)) as coupons_balance,
			DATE_FORMAT(t.start_date,'%Y-%m-%d') as start_date,
			DATE_FORMAT(t.end_date,'%Y-%m-%d') as end_date,
			t.unit_id,
			t.is_activity,t.is_multi,t.is_limit_amount,t.limit_amount,t.is_limit_type,t.limit_type,
			t.is_limit_mark,t.limit_mark,t.is_limit_goods,t.limit_goods,t.is_limit_platform,
			t.limit_platform,
			r.id as rid,r.claim_code,r.source_code,r.use_date,r.account,r.order_no,r.coupons_id,
			if (r.status=0 and t.end_date &lt; now(),-1,r.status) as status,
			datediff(t.end_date,now()) as remain_day,
			if(t.zone_code=null or t.zone_code='',1,t.zone_code) as zone_code
			from tb_coupons_user_rt r,tb_coupons t
			where t.id=r.coupons_id		
			and r.account = #{account}
			<if test="couponsName!=null and couponsName!=''">
				and t.coupons_name like #{couponsName}
			</if>
		) as f,tb_sys_units n
		<trim prefix="WHERE" prefixOverrides="AND |OR ">
			f.zone_code=n.zone_code  and f.unit_id=n.id
			<if test="couponsStatus!=null and couponsStatus!=''">
				and f.status = #{couponsStatus}
			</if>
		</trim>
		order by f.remain_day asc
		<if test="page!=null and page!='' and pagesize!=null and pagesize!=''">
			limit ${(page-1)*pagesize},${pagesize}
		</if>
		
	</select>


	<!-- 获取待领取优惠券列表      当前区域发放或者平台公司发放 -->
	<select id="getUnclaimedCouponsList" parameterType="hashmap" resultType="hashmap">
		select * from (
			select
				t.id as couponsId,
				t.unit_id,t.unit_type,t.zone_code,		
				t.coupons_code,t.coupons_name,
				convert(t.coupons_balance,char(6)) as coupons_balance,
				DATE_FORMAT(t.create_date,'%Y-%m-%d') as create_date,
				DATE_FORMAT(t.start_date,'%Y-%m-%d') as start_date,
				DATE_FORMAT(t.end_date,'%Y-%m-%d') as end_date,
				t.status,
				t.is_activity,t.is_multi,t.is_limit_amount,t.limit_amount,t.is_limit_type,t.limit_type,
				t.is_limit_mark,t.limit_mark,t.is_limit_goods,t.limit_goods,t.is_limit_platform,
				t.limit_platform,t.memo,t.is_limit_count,t.claimed_count,s.source_code,
				n.short_name,
				if (t.is_limit_count=1 and t.claimed_count &gt;= t.limit_count,1,0) as limit_status
			from tb_coupons_source s,tb_coupons t,tb_coupons_source_rt r,tb_sys_units n
			where 
				s.start_date &lt;= now() and s.end_date &gt;= now()
			and s.status=0			
			<if test="sourceCode!=null and sourceCode!=''">
				and s.source_code=#{sourceCode}
			</if>	
			and t.start_date &lt;= now() and t.end_date &gt;= now()
			and t.status=0
			and (t.zone_code=#{zoneCode} or t.unit_id=1)
			<if test="myClaimedIdList!=null and myClaimedIdList!=''">
				and t.id not in			
				<foreach collection="myClaimedIdList" item="couponsId" open="(" separator="," close=")"> 
					#{couponsId}
				</foreach>
			</if>			
			and r.source_id=s.id 
			and r.coupons_id=t.id
			and r.status=0
			and t.zone_code=n.zone_code
			order by t.create_date desc
		) l where l.limit_status=0
		limit ${(page-1)*pagesize},${pagesize}
	</select>
	
	
	<!-- 获取我已领取的优惠券id -->
	<select id="getMyClaimedIdList" parameterType="hashmap" resultType="long">
		select r.coupons_id as couponsId from tb_coupons_user_rt r where r.account = #{account}
		<if test="sourceCode!=null and sourceCode!=''">
			and r.source_code=#{sourceCode}
		</if>		 
	</select>
	
	
	<!-- 获取待领取优惠券数量      当前区域发放或者平台公司发放 -->
	<select id="getUnclaimedCouponsCount" parameterType="hashmap" resultType="hashmap">
	select count(l.id) as unclaimed_count from(
		select
			t.id,
			if (t.is_limit_count=1 and t.claimed_count &gt;= t.limit_count,1,0) as limit_status
		from tb_coupons_source s,tb_coupons t,tb_coupons_source_rt r,tb_sys_units n
		where 
			s.start_date &lt;= now() and s.end_date &gt;= now()
		and s.status=0 	
		<if test="sourceCode!=null and sourceCode!=''">
			and s.source_code=#{sourceCode}
		</if>		
		and t.start_date &lt;= now() and t.end_date &gt;= now()
		and t.status=0
		and (t.zone_code=#{zoneCode} or t.unit_id=1)
		<if test="myClaimedIdList!=null and myClaimedIdList!=''">
				and t.id not in			
				<foreach collection="myClaimedIdList" item="couponsId" open="(" separator="," close=")"> 
					#{couponsId}
				</foreach>
			</if>			
		and r.source_id=s.id 
		and r.coupons_id=t.id
		and r.status=0
		and t.zone_code=n.zone_code
		order by t.create_date desc	
	) l where l.limit_status=0	
	</select>
	
	
	<!-- 获取优惠券详细 -->
	<select id="getCoupons" parameterType="hashmap" resultType="hashmap">
		select t.id as couponsId,
			t.unit_id,t.unit_type,t.zone_code,		
			t.coupons_code,t.coupons_name,
			convert(t.coupons_balance,char(6)) as coupons_balance,
			DATE_FORMAT(t.create_date,'%Y-%m-%d') as create_date,
			DATE_FORMAT(t.start_date,'%Y-%m-%d') as start_date,
			DATE_FORMAT(t.end_date,'%Y-%m-%d') as end_date,
			t.is_activity,t.is_multi,t.is_limit_amount,t.limit_amount,t.is_limit_type,t.limit_type,
			t.is_limit_mark,t.limit_mark,t.is_limit_goods,t.limit_goods,t.is_limit_platform,
			t.limit_platform,t.memo,r.claim_code,r.source_code,
			if (r.status=0 and t.end_date &lt; now(),-1,r.status) as status
		from tb_coupons t,tb_coupons_user_rt r 
		where t.id = #{couponsId} and t.id=r.coupons_id
		and r.id=#{rid}
	</select>
	
	<!-- 获取优惠券详细 -->
	<select id="getCouponsDetail" parameterType="long" resultType="hashmap">
		select d.*
		from tb_coupons_detail d
		where d.coupons_id = #{couponsId}		
	</select>
	
	
	<!-- 根据来源编码 获取优惠券来源 -->
	<select id="getCouponsBySourceCode" parameterType="hashmap" resultType="hashmap">
		select s.*
		from  tb_coupons_source s
		where s.source_code = #{sourceCode} and s.status=0
		and s.start_date &lt;= now() and s.end_date &gt;= now()
		and (s.zone_code=1
			<if test="zoneCode!=null and zoneCode!=''">
				or s.zone_code = #{zoneCode}
			</if>
		)
	</select>
	
	
	<!-- 获取批量领取优惠券列表 -->
	<select id="getBatchCouponsList" parameterType="hashmap" resultType="hashmap">
		select c.*,s.id as sid 
		from tb_coupons c,tb_coupons_source_rt r,tb_coupons_source s
		where c.id=r.coupons_id and s.id = r.source_id
		and s.source_code=#{sourceCode}
		and s.start_date &lt;= now() and s.end_date &gt;= now()
		and s.status=0 and c.status=0 and r.status=0
		<if test="myClaimedIdList!=null and myClaimedIdList!=''">
				and c.id not in			
				<foreach collection="myClaimedIdList" item="couponsId" open="(" separator="," close=")"> 
					#{couponsId}
				</foreach>
		</if>		
		<!--  and c.id not in (select r.coupons_id from tb_coupons_user_rt r where r.account = #{account})-->
		and c.start_date &lt;=now() and c.end_date &gt;= now() 
		and (c.zone_code=1
			<if test="zoneCode!=null and zoneCode!=''">
				or c.zone_code = #{zoneCode}
			</if>
		)
		<if test="sid!=null and sid!=''">
			and s.id=#{sid}
		</if>
	</select>
	
	
	<!-- 商品列表列 -->
	<sql id="goodsPriceListColumn">
			gp.id,
			gp.goods_id,
			gp.goods_number,
			gp.goods_name,
			gp.goods_nick_name,
			gp.member_price,
			gp.market_price,
			gp.sell_price,
			gp.version,
			gp.`status`,
			gp.is_activity,
			gp.create_date,
			gp.activity_price,
			gp.is_gift,
			gp.goods_edit_status,
			gp.ord,
			gp.sell_rate,
			fd.id as file_data_id,
			case when gp.is_activity = 1 THEN gp.activity_price ELSE gp.member_price END as single_price,
			CONCAT('?bn=fileDataService&amp;id=',CAST(fd.id AS CHAR)) as img
	</sql>
	
	<!-- 查看可用优惠券商品列表 -->
	<select id="getAvailableGoodsListMap" parameterType="hashmap" resultType="hashmap">
	select gpl.* from (
		SELECT
			<include refid="goodsPriceListColumn"></include>
		FROM
			tb_goods_price gp
		JOIN tb_file_data fd ON gp.id = fd.data_id 
		AND fd.data_type = 1 and fd.ord = 1  AND fd.file_type = 0
		AND gp.version = fd.data_version
		WHERE
			gp.unit_id = #{unitId}
		AND gp.unit_type = #{unitType} 
		AND gp.status = 0
		AND gp.goods_status = 0
		and fd.if_delete = 0 
		<if test="goodsTypeId!=null and goodsTypeId!=''">
			and gp.goods_type_id = #{goodsTypeId}
		</if>
		<if test="keyWord!=null and keyWord!=''">
			and (gp.goods_name like #{keyWord}
			or gp.goods_nick_name like #{keyWord}
			or gp.spell_name like #{keyWord}
			or gp.fir_spell_name like #{keyWord})  
		</if>
		) gpl
		<choose>
			<when test="sortname !=null and sortname !=''">
				order by ${sortname}
				<if test="sortorder !=null and sortorder !='' ">
					${sortorder} 
				</if>
			</when>
			<otherwise>
				order by gpl.ord desc
			</otherwise>
		</choose>
		,gpl.create_date desc
		limit ${(page-1)*pagesize},${pagesize}
	</select>
	
	
	<!-- 获取单位信息 -->
	<select id="getListByZoneCodeAndUnitType" parameterType="hashmap"  resultType="hashmap">
		SELECT * FROM tb_sys_units where zone_code = #{zoneCode} and unit_type = #{unitType}
	</select>
	
	
	<!-- 获取海报选中优惠券列表 -->
	<select id="getPosterCouponsList" parameterType="hashmap" resultType="hashmap">
		select * from (
			select
				t.id as couponsId,
				t.unit_id,t.unit_type,t.zone_code,		
				t.coupons_code,t.coupons_name,
				convert(t.coupons_balance,char(6)) as coupons_balance,
				DATE_FORMAT(t.create_date,'%Y-%m-%d') as create_date,
				DATE_FORMAT(t.start_date,'%Y-%m-%d') as start_date,
				DATE_FORMAT(t.end_date,'%Y-%m-%d') as end_date,
				t.status,
				t.is_activity,t.is_multi,t.is_limit_amount,t.limit_amount,t.is_limit_type,t.limit_type,
				t.is_limit_mark,t.limit_mark,t.is_limit_goods,t.limit_goods,t.is_limit_platform,
				t.limit_platform,t.memo,t.is_limit_count,t.claimed_count,
				n.short_name,
				if (t.is_limit_count=1 and t.claimed_count &gt;= t.limit_count,1,0) as limit_status
			from tb_coupons t,tb_sys_units n,tb_advert_subject_info_rt rt
			where 		
				t.start_date &lt;= now() and t.end_date &gt;= now()
			and t.status=0
			and (t.zone_code=#{zoneCode} or t.unit_id=1)
			and rt.data_type = 'coupons'
			and rt.data_1 = t.id
			and rt.subject_id = #{subjectId}
			and rt.status=0
			<if test="myClaimedIdList!=null and myClaimedIdList!=''">
				and t.id not in			
				<foreach collection="myClaimedIdList" item="couponsId" open="(" separator="," close=")"> 
					#{couponsId}
				</foreach>
			</if>			
			and t.zone_code=n.zone_code
			order by t.create_date desc
		) l where l.limit_status=0
	</select>
	
	
	<!-- 获取当前用户已领取海报优惠券列表id -->
	<select id="getMyPosterClaimedIdList" parameterType="hashmap" resultType="long">
		select DISTINCT r.coupons_id as couponsId 
		from tb_coupons_user_rt r , tb_advert_subject_info_rt rt
		where r.account = #{account}
			and rt.data_type = 'coupons'
			and rt.data_1 = r.coupons_id
			and rt.subject_id = #{subjectId}
			and rt.status=0
		<if test="sourceCode!=null and sourceCode!=''">
			and r.source_code=#{sourceCode}
		</if>		 
	</select>
	
	
</mapper>